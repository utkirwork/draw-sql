<?php

namespace {{namespace}}\repository;

use {{namespace}}\models\\{{modelName}};
use yii\data\ActiveDataProvider;
use yii\db\ActiveQuery;

/**
 * Class {{modelName}}Repository
 * Repository for {{modelName}} model
 */
class {{modelName}}Repository
{
    /**
     * Find by ID
     * @param int $id
     * @return {{modelName}}|null
     */
    public function findById(int $id): ?{{modelName}}
    {
        return {{modelName}}::findOne($id);
    }

    /**
     * Find all records
     * @return {{modelName}}[]
     */
    public function findAll(): array
    {
        return {{modelName}}::find()->all();
    }

    /**
     * Find with pagination
     * @param array $params
     * @return ActiveDataProvider
     */
    public function findWithPagination(array $params = []): ActiveDataProvider
    {
        $query = {{modelName}}::find();
        
        return new ActiveDataProvider([
            'query' => $query,
            'pagination' => [
                'pageSize' => $params['pageSize'] ?? 20,
            ],
            'sort' => [
                'defaultOrder' => [
                    'id' => SORT_DESC,
                ]
            ],
        ]);
    }

    /**
     * Save model
     * @param {{modelName}} $model
     * @return bool
     */
    public function save({{modelName}} $model): bool
    {
        return $model->save();
    }

    /**
     * Save model and throw exception on error
     * @param {{modelName}} $model
     * @return {{modelName}}
     * @throws \Exception
     */
    public function saveThrow({{modelName}} $model): {{modelName}}
    {
        if (!$model->save()) {
            throw new \Exception('Failed to save {{modelNameLower}}: ' . implode(', ', $model->getFirstErrors()));
        }
        return $model;
    }

    /**
     * Delete model
     * @param {{modelName}} $model
     * @return bool
     * @throws \Throwable
     * @throws \yii\db\StaleObjectException
     */
    public function delete({{modelName}} $model): bool
    {
        return (bool) $model->delete();
    }

    /**
     * Find by condition
     * @param array $condition
     * @return {{modelName}}|null
     */
    public function findByCondition(array $condition): ?{{modelName}}
    {
        return {{modelName}}::find()->where($condition)->one();
    }

    /**
     * Find all by condition
     * @param array $condition
     * @return {{modelName}}[]
     */
    public function findAllByCondition(array $condition): array
    {
        return {{modelName}}::find()->where($condition)->all();
    }

    /**
     * Count records
     * @param array $condition
     * @return int
     */
    public function count(array $condition = []): int
    {
        $query = {{modelName}}::find();
        if (!empty($condition)) {
            $query->where($condition);
        }
        return $query->count();
    }

    /**
     * Check if exists
     * @param array $condition
     * @return bool
     */
    public function exists(array $condition): bool
    {
        return {{modelName}}::find()->where($condition)->exists();
    }

{{#each uniqueColumns}}
    /**
     * Get by {{name}}
     * @param mixed ${{name}}
     * @return {{../modelName}}|null
     */
    public function getBy{{properCase name}}(${{name}}): ?{{../modelName}}
    {
        return {{../modelName}}::find()->{{name}}(${{name}})->one();
    }

    /**
     * Check if exists by {{name}}
     * @param mixed ${{name}}
     * @param int|null $excludeId
     * @return bool
     */
    public function existsBy{{properCase name}}(${{name}}, $excludeId = null): bool
    {
        $query = {{../modelName}}::find()->{{name}}(${{name}});
        if ($excludeId) {
            $query->andWhere(['!=', 'id', $excludeId]);
        }
        return $query->exists();
    }

{{/each}}
} 